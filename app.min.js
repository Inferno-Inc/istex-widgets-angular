var app=angular.module("app",[]);app.controller("IstexauthCtrl",["$scope","$rootScope",function($scope,$rootScope){var infos=JSON.parse(localStorage.getItem("infos"));infos&&infos.isConnected?$rootScope.isConnected=!0:$rootScope.isConnected=!1,$scope.connect=function(){localStorage.setItem("infos",JSON.stringify({isConnected:"true"})),$rootScope.isConnected=!0}}]),app.controller("IstexfacetsCtrl",["$scope","$rootScope","$timeout","istexFacetsService",function($scope,$rootScope,$timeout,istexFacetsService){$scope.onChange=function($event){$timeout(function(){angular.element($event.target.form).triggerHandler("submit")})},$scope.corpusSearch=function(listCorpus){$rootScope.showSearch=!1,istexFacetsService.corpusSearch($scope,listCorpus).success(function(result){$rootScope.searchTimeB=performance.now(),$rootScope.totalSearchTime=(($rootScope.searchTimeB-$rootScope.searchTimeA)/1e3).toFixed(2),$rootScope.elasticSearchTime=(result.stats.elasticsearch.took/1e3).toFixed(2),$rootScope.istexSearchTime=(result.stats["istex-api"].took/1e3).toFixed(2),$rootScope.reseauSearchTime=($rootScope.totalSearchTime-$rootScope.elasticSearchTime-$rootScope.istexSearchTime).toFixed(2),$rootScope.documents=result.hits,$rootScope.total=result.total,$rootScope.nextPageURI=result.nextPageURI,$rootScope.maxPagesInPagination=$rootScope.istexConfigDefault.maxPagesInPagination,$rootScope.nbrPages=Math.ceil($rootScope.total/$rootScope.istexConfigDefault.pageSize),$rootScope.firstPageURI={id:1},$rootScope.lastPageURI={id:$rootScope.nbrPages},$rootScope.nbrPages<$rootScope.maxPagesInPagination&&($rootScope.maxPagesInPagination=$rootScope.nbrPages),$rootScope.pageCourante=1;var tab=[];for(i=1;i<=$rootScope.maxPagesInPagination;i++)tab.push({id:i});$rootScope.pages=tab,$rootScope.showSearch=!0}).error(function(e){console.log("ERROR : Corpus Search")})}}]),app.controller("IstexresultsCtrl",["$scope","$rootScope","istexResultsService",function($scope,$rootScope,istexResultsService){$scope.selectPage=function(numPage){$rootScope.hideResults=!0;var page=(numPage-1)*$rootScope.istexConfigDefault.pageSize;$rootScope.pageCourante=numPage,$rootScope.pageCourante>=1+Math.ceil($rootScope.maxPagesInPagination/2)&&$rootScope.pageCourante<=$rootScope.nbrPages-Math.ceil($rootScope.maxPagesInPagination/2)?($rootScope.pageStart=$rootScope.pageCourante-Math.floor($rootScope.maxPagesInPagination/2-.5),$rootScope.pageEnd=$rootScope.pageCourante+Math.ceil($rootScope.maxPagesInPagination/2-.5)):$rootScope.pageCourante<1+Math.ceil($rootScope.maxPagesInPagination/2)?($rootScope.pageStart=1,$rootScope.pageEnd=$rootScope.maxPagesInPagination):$rootScope.pageCourante>$rootScope.nbrPages-Math.ceil($rootScope.maxPagesInPagination/2)&&($rootScope.pageStart=$rootScope.nbrPages-$rootScope.maxPagesInPagination+1,$rootScope.pageEnd=$rootScope.nbrPages);var tab=[];for(i=$rootScope.pageStart;i<=$rootScope.pageEnd;i++)tab.push({id:i});$rootScope.pages=tab,istexResultsService.search(page).success(function(result){$rootScope.searchTimeB=performance.now(),$rootScope.totalSearchTime=(($rootScope.searchTimeB-$rootScope.searchTimeA)/1e3).toFixed(2),$rootScope.elasticSearchTime=(result.stats.elasticsearch.took/1e3).toFixed(2),$rootScope.istexSearchTime=(result.stats["istex-api"].took/1e3).toFixed(2),$rootScope.reseauSearchTime=($rootScope.totalSearchTime-$rootScope.elasticSearchTime-$rootScope.istexSearchTime).toFixed(2),$rootScope.documents=result.hits,$rootScope.nextPageURI=result.nextPageURI,$rootScope.hideResults=!1}).error(function(e){console.error("ERROR : Pagination")})}}]),app.controller("IstexsearchCtrl",["$scope","$rootScope","istexSearchService",function($scope,$rootScope,istexSearchService){$rootScope.showSearch=!1,$rootScope.showFacets=!1,$rootScope.numberResults=4,$scope.search=function(){$rootScope.showSearch=!1,$rootScope.showFacets=!1,istexSearchService.search($scope).success(function(result){$rootScope.searchTimeB=performance.now(),$rootScope.totalSearchTime=(($rootScope.searchTimeB-$rootScope.searchTimeA)/1e3).toFixed(2),$rootScope.elasticSearchTime=(result.stats.elasticsearch.took/1e3).toFixed(2),$rootScope.istexSearchTime=(result.stats["istex-api"].took/1e3).toFixed(2),$rootScope.reseauSearchTime=($rootScope.totalSearchTime-$rootScope.elasticSearchTime-$rootScope.istexSearchTime).toFixed(2),$rootScope.documents=result.hits,$rootScope.total=result.total,$rootScope.nextPageURI=result.nextPageURI,$rootScope.aggregations=result.aggregations,$rootScope.showSearch=!0,$rootScope.showFacets=!0,$rootScope.maxPagesInPagination=$rootScope.istexConfigDefault.maxPagesInPagination,$rootScope.nbrPages=Math.ceil($rootScope.total/$rootScope.istexConfigDefault.pageSize),$rootScope.firstPageURI={id:1},$rootScope.lastPageURI={id:$rootScope.nbrPages},$rootScope.nbrPages<$rootScope.maxPagesInPagination&&($rootScope.maxPagesInPagination=$rootScope.nbrPages),$rootScope.pageCourante=1;var tab=[];for(i=1;i<=$rootScope.maxPagesInPagination;i++)tab.push({id:i});$rootScope.pages=tab}).error(function(e){console.error("ERROR : Search")})}}]),app.directive("istexAuth",function(){return{template:'<div id="istex-widget-auth" ng-controller="IstexauthCtrl"><button class="istex-ezproxy-auth-btn" ng-if="!isConnected" ng-click="connect()">Se connecter<div></div></button></div>'}}),app.directive("istexFacets",function(){return{template:'<div id="istex-widget-facets" style="opacity: 1;" ng-controller="IstexfacetsCtrl" ng-if="showFacets && aggregations"><div class="istex-facets"><h3 class="istex-facets-title">Affiner votre recherche</h3><div class="istex-facet" ng-repeat="(facetName, facet) in aggregations"><h4 class="istex-facet-name">{{ facetName | capitalize }}</h4><div class="animate-switch-container" ng-switch on="facetName"><form class="istex-facet-{{ facetName }}" ng-submit="corpusSearch(facet.buckets)" ng-switch-when="corpus"><li ng-repeat="badge in facet.buckets"><label><input type="checkbox" ng-model="badge.isChecked" ng-click="onChange($event)">{{ badge.key }}<span class="istex-facet-corpus-badge" >{{ badge.doc_count | numberize }}</span></label></li></form><div class="animate-switch" ng-switch-when="copyrightdate">Copyrightdate : WIP</div><div class="animate-switch" ng-switch-default>Default behavior</div></div></div></div></div>'}}),app.directive("istexResults",function(){return{template:'<div id="istex-widget-results" style="opacity: 1;" ng-controller="IstexresultsCtrl" ng-show="showSearch"><div class="istex-results-items-stats" ng-hide="hideResults">Environ {{ total | numberize }} résultats <span title="Réseau : {{reseauSearchTime}} sec, Moteur de recherche : {{elasticSearchTime}} sec, Traitements de l\'API : {{istexSearchTime}} sec">({{totalSearchTime}} secondes)</span></div><div class="istex-results-pagination" ng-if="istexConfigDefault.showPagination"><a href="#" class="istex-results-pagination-prec" title="Page précédente" ng-click="selectPage(pageCourante-1)" ng-if="pageCourante !== firstPageURI.id"> < </a><ul class="istex-results-pagination-plist"><li ng-repeat="page in pages" ><a href="#" ng-click="selectPage(page.id)" ng-if="pageCourante !== page.id ">{{page.id}}</a><span class="istex-results-pagination-page-selected" ng-if="pageCourante === page.id">{{page.id}}</span></li></ul><a href="#" class="istex-results-pagination-next" title="Page suivante" ng-click="selectPage(pageCourante+1)" ng-if="pageCourante !== lastPageURI.id"> > </a></div><ol class="istex-results-items" ng-hide="hideResults"><li class="istex-results-item" ng-repeat="document in documents"><a class="istex-results-item-title" target="_blank">{{ document.title | ellipse:false:istexConfigDefault.titleLength:"..." }}</a><p class="istex-results-item-abstract" ng-if="document.abstract" title="{{ document.abstract }}"><b>Résumé</b> : {{ document.abstract | ellipse:false:istexConfigDefault.abstractLength:"..."  }}</p><p class="istex-results-item-abstract" title="Pas de résumé" ng-if="!document.abstract">Pas de résumé disponible pour cet article</p><div class="istex-results-item-corpus">{{ document.corpusName }}</div><div class="download fulltext"><h4>Texte complet</h4><ul class="istex-results-item-download"><li class="istex-results-item-dl fulltext" ng-repeat="fulltext in document.fulltext"><a href="{{ fulltext.uri }}" ng-href="{{ fulltext.uri }}" class="istex-results-item-dl-{{ fulltext.extension }}" title="Télécharger le ou les fichiers {{ fulltext.extension | uppercase }}" target="_blank">{{ fulltext.extension | uppercase }}</a></li></ul></div><div class="download metadata"><h4>Metadata</h4><ul class="istex-results-item-download metadata"><li class="istex-results-item-dl" ng-repeat="metadata in document.metadata"><a href="{{ metadata.uri }}" ng-href="{{ metadata.uri }}" class="istex-results-item-dl-{{ metadata.extension }}" title="Télécharger le ou les fichiers {{ metadata.extension | uppercase }}" target="_blank">{{ metadata.extension | uppercase }}</a></li></ul></div><div class="istex-results-item-bottom"></div><hr style="border-top-color: black;"/></li></ol><div class="istex-results-pagination" ng-if="istexConfigDefault.showPagination"><a href="#" class="istex-results-pagination-prec" title="Page précédente" ng-click="selectPage(pageCourante-1)" ng-if="pageCourante !== firstPageURI.id"> < </a><ul class="istex-results-pagination-plist"><li ng-repeat="page in pages" ><a href="#" ng-click="selectPage(page.id)" ng-if="pageCourante !== page.id ">{{page.id}}</a><span class="istex-results-pagination-page-selected" ng-if="pageCourante === page.id">{{page.id}}</span></li></ul><a href="#" class="istex-results-pagination-next" title="Page suivante" ng-click="selectPage(pageCourante+1)" ng-if="pageCourante !== lastPageURI.id"> > </a></div></div>'}}),app.directive("istexSearch",function(){return{template:'<div id="istex-widget-search" ng-controller="IstexsearchCtrl" ng-if="isConnected"><form class="istex-search-form"  ng-submit="search()"><div class="istex-search-bar-wrapper"><input class="istex-search-submit" type="submit" value="Rechercher" ><span><input class="istex-search-input" type="search" value="" placeholder="Votre requête ici ..." ng-model="query"></span></div><p class="istex-search-error"></p><div class="istex-search-loading" title="Recherche en cours"></div></form></div>'}}),app.factory("istexFacetsService",["$http","$rootScope",function($http,$rootScope){return{corpusSearch:function(scope,listCorpus){function urlMaker(element,index,array){element.isChecked&&(corpus+=element.key+",")}var url=$rootScope.currentPageURI,corpus="&corpus=";return listCorpus.forEach(urlMaker),corpus="&corpus="!=corpus?corpus.substring(0,corpus.length-1):"",url+=corpus,$rootScope.currentCorpusURI=corpus,$rootScope.searchTimeA=performance.now(),$http.get(url)}}}]),app.factory("istexResultsService",["$http","$rootScope",function($http,$rootScope){return{search:function(page){var url=$rootScope.currentPageURI;$rootScope.currentCorpusURI&&(url+=$rootScope.currentCorpusURI);var from="&from=";return from+=page,url+=from,$rootScope.searchTimeA=performance.now(),$http.get(url)},advancedSearch:function(scope,options){}}}]),app.factory("istexSearchService",["$http","$rootScope",function($http,$rootScope){return{search:function(scope){var url=$rootScope.istexConfigDefault.istexApi;url+="/document/?q=";var query=scope.query?scope.query.toString():"";url+=""!=query?query:"*",url+="&output=*",url+="&stats=1";var facets="&facet="+$rootScope.istexConfigDefault.facetsToLoad.join(),size="&size="+$rootScope.istexConfigDefault.pageSize;return url+=facets+size,$rootScope.currentPageURI=url,$rootScope.searchTimeA=performance.now(),$http.get(url)},advancedSearch:function(scope,options){}}}]),app.filter("capitalize",function(){return function(input,scope){return null!=input&&(input=input.toLowerCase()),input.substring(0,1).toUpperCase()+input.substring(1)}}),app.filter("numberize",function(){return function(input,scope){return null!=input&&(input=input.toString().replace(/(\d)(?=(\d{3})+$)/g,"$1 ")),input}}),app.filter("ellipse",function(){return function(value,wordwise,max,tail){if(!value)return"";if(max=parseInt(max,10),!max)return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");-1!=lastspace&&(value=value.substr(0,lastspace))}return value+(tail||" �")}}),app.run(["$rootScope",function($rootScope){$rootScope.istexConfigDefault={istexApi:"https://api.istex.fr",query:"",facetsToLoad:["corpus"],showPagination:!0,pageSize:10,maxPagesInPagination:10,abstractLength:250,titleLength:150,fullTextOnTitle:"pdf",showQuerySpeed:!0,labels:{facets:{title:"Affiner votre recherche",corpus:"Corpus"}}},Object.getOwnPropertyNames(window.istexConfig).length>0}]),angular.element(document).ready(function(){angular.bootstrap(document,["app"])});